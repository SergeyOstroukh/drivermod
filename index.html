<!doctype html>
<html lang="ru">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Маршруты к поставщикам</title>
	<link rel="stylesheet" href="styles.css">
	<link rel="preconnect" href="https://yastatic.net">
	<meta name="theme-color" content="#111827">
</head>
<body>
	<header class="header">
		<nav class="nav-tabs">
			<button class="nav-tab active" data-section="suppliers">Поставщики</button>
			<button class="nav-tab" data-section="drivers">Водители</button>
			<button class="nav-tab" data-section="vehicles">Автомобили</button>
		</nav>
		<div class="header-top">
			<h1 id="pageTitle">Поставщики</h1>
			<label class="search">
				<input id="searchInput" class="search-input" type="search" placeholder="Поиск по названию" autocomplete="off" />
			</label>
			<div class="header-actions">
			<button id="addSupplierBtn" class="btn btn-primary" type="button">
				<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<line x1="12" y1="5" x2="12" y2="19"></line>
					<line x1="5" y1="12" x2="19" y2="12"></line>
				</svg>
				Добавить
			</button>
			<button id="officeBtn" class="btn btn-secondary" type="button">
				<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
					<circle cx="12" cy="10" r="3"></circle>
				</svg>
				Офис
			</button>
			<button id="warehouseBtn" class="btn btn-secondary" type="button">
				<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
					<circle cx="12" cy="10" r="3"></circle>
				</svg>
				Склад
			</button>
			<button id="detectLocationBtn" class="btn btn-secondary" type="button">Обновить геопозицию</button>
			</div>
		</div>
	</header>

	<main id="app" class="container">
		<!-- Раздел Поставщики -->
		<div id="suppliersSection" class="content-section active">
			<section id="status" class="status">
				<span id="geoStatus">Ожидание геопозиции…</span>
			</section>

			<section class="route-section">
				<button id="buildRouteBtn" class="btn btn-primary route-btn" type="button" disabled>
					Поехать по маршруту
				</button>
				<button id="clearSelectionBtn" class="btn btn-outline route-btn" type="button">
					Сбросить выбранное
				</button>
			</section>

			<section>
				<ul id="suppliersList" class="cards"></ul>
			</section>
		</div>

		<!-- Раздел Водители -->
		<div id="driversSection" class="content-section">
			<section class="section-header">
				<button id="addDriverBtn" class="btn btn-primary" type="button">
					<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					Добавить водителя
				</button>
			</section>
			<section>
				<ul id="driversList" class="cards"></ul>
			</section>
		</div>

		<!-- Раздел Автомобили -->
		<div id="vehiclesSection" class="content-section">
			<section class="section-header">
				<button id="addVehicleBtn" class="btn btn-primary" type="button">
					<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<line x1="12" y1="5" x2="12" y2="19"></line>
						<line x1="5" y1="12" x2="19" y2="12"></line>
					</svg>
					Добавить автомобиль
				</button>
			</section>
			<section>
				<ul id="vehiclesList" class="cards"></ul>
			</section>
		</div>

		<!-- Раздел Лог пробега -->
		<div id="mileageSection" class="content-section" style="display: none;">
			<section class="section-header">
				<button id="backToVehiclesFromMileageBtn" class="btn btn-outline" type="button">
					<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M19 12H5M12 19l-7-7 7-7"></path>
					</svg>
					Назад к автомобилям
				</button>
				<h2 id="mileageSectionTitle" class="section-title">Лог пробега</h2>
				<button id="printMileageBtn" class="btn btn-primary" type="button" style="margin-left: auto;">
					<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<polyline points="6 9 6 2 18 2 18 9"></polyline>
						<path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
						<rect x="6" y="14" width="12" height="8"></rect>
					</svg>
					Печать
				</button>
			</section>
			<section class="mileage-content">
				<div class="mileage-form-section">
					<h3 class="mileage-form-title">Ввести пробег</h3>
					<form id="mileageForm" class="supplier-form">
						<div class="form-group">
							<label for="mileageDriver" class="form-label">Водитель *</label>
							<select id="mileageDriver" name="driver_id" class="form-input" required>
								<option value="">Выберите водителя</option>
							</select>
						</div>
						<div class="form-group">
							<label for="mileageValue" class="form-label">Общий пробег (км) *</label>
							<input type="number" id="mileageValue" name="mileage" class="form-input" min="0" required placeholder="0" />
						</div>
						<div class="form-group">
							<label for="mileageDate" class="form-label">Дата *</label>
							<input type="date" id="mileageDate" name="log_date" class="form-input" required />
						</div>
						<div class="form-group" id="fuelLevelGroup" style="display: none;">
							<label for="mileageFuelLevel" class="form-label">Начальный уровень топлива (л) *</label>
							<input type="number" id="mileageFuelLevel" name="fuel_level" class="form-input" min="0" step="0.1" placeholder="0" />
							<small class="form-hint">Укажите только для первой записи</small>
						</div>
						<div class="form-group">
							<label for="mileageFuelRefill" class="form-label">Заправка за смену (л)</label>
							<input type="number" id="mileageFuelRefill" name="fuel_refill" class="form-input" min="0" step="0.1" placeholder="0" />
							<small class="form-hint">Оставьте пустым, если заправки не было</small>
						</div>
						<div class="form-group">
							<label for="mileageNotes" class="form-label">Примечания</label>
							<textarea id="mileageNotes" name="notes" class="form-textarea" rows="2" placeholder="Дополнительная информация..."></textarea>
						</div>
						<div class="form-actions">
							<button type="submit" class="btn btn-primary">Добавить</button>
						</div>
					</form>
				</div>
				<div class="mileage-table-section">
					<div class="mileage-filters">
						<label for="mileageMonthFilter" class="form-label">Месяц:</label>
						<input type="month" id="mileageMonthFilter" class="form-input" />
						<button id="mileageFilterBtn" class="btn btn-outline">Применить</button>
					</div>
					<div class="table-wrapper">
						<table class="mileage-table" id="mileageTable">
							<thead>
								<tr>
									<th>Дата</th>
									<th>Водитель</th>
									<th>Пробег (км)</th>
									<th>Пробег за смену (км)</th>
									<th>Расход топлива (л)</th>
									<th>Заправка (л)</th>
									<th>Уровень топлива (л)</th>
									<th>Примечания</th>
									<th>Действия</th>
								</tr>
							</thead>
							<tbody id="mileageTableBody">
								<tr>
									<td colspan="9" style="text-align: center; color: var(--muted);">Загрузка...</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</section>
		</div>

		<!-- Раздел История использования -->
		<div id="historySection" class="content-section" style="display: none;">
			<section class="section-header">
				<button id="backToVehiclesBtn" class="btn btn-outline" type="button">
					<svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M19 12H5M12 19l-7-7 7-7"></path>
					</svg>
					Назад к автомобилям
				</button>
				<h2 id="historySectionTitle" class="section-title">История использования</h2>
			</section>
			<section class="history-content">
				<div class="history-form-section">
					<h3 class="history-form-title">Добавить запись</h3>
					<form id="historyForm" class="supplier-form">
						<div class="form-group">
							<label for="historyDriver" class="form-label">Водитель *</label>
							<select id="historyDriver" name="history_driver_id" class="form-input" required>
								<option value="">Выберите водителя</option>
							</select>
						</div>
						<div class="form-group">
							<label for="historyStartDate" class="form-label">Дата начала *</label>
							<input type="date" id="historyStartDate" name="history_start_date" class="form-input" required />
						</div>
						<div class="form-group">
							<label for="historyEndDate" class="form-label">Дата окончания</label>
							<input type="date" id="historyEndDate" name="history_end_date" class="form-input" />
							<small class="form-hint">Оставьте пустым, если период еще не закончен</small>
						</div>
						<div class="form-group">
							<label for="historyNotes" class="form-label">Примечания</label>
							<textarea id="historyNotes" name="history_notes" class="form-textarea" rows="2" placeholder="Дополнительная информация..."></textarea>
						</div>
						<div class="form-actions">
							<button type="submit" class="btn btn-primary">Добавить</button>
						</div>
					</form>
				</div>
				<div class="history-table-section">
					<h3 class="history-table-title">История</h3>
					<div class="table-wrapper">
						<table class="history-table">
							<thead>
								<tr>
									<th>Водитель</th>
									<th>Дата начала</th>
									<th>Дата окончания</th>
									<th>Примечания</th>
									<th>Действия</th>
								</tr>
							</thead>
							<tbody id="historyTableBody">
								<tr>
									<td colspan="5" style="text-align: center; color: var(--muted);">Загрузка...</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</section>
		</div>
	</main>

	<footer class="footer">
		<div>© <span id="year"></span> Маршруты к поставщикам</div>
	</footer>

	<div id="routeModal" class="modal">
		<div class="modal-content">
			<h3 class="modal-title">Выберите способ открытия маршрута</h3>
			<div id="navigatorWarning" class="modal-warning" style="display: none;">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M12 9v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path>
				</svg>
				<span>Лимит: 5 вызовов в сутки без ключа API</span>
			</div>
			<div id="multiRouteWarning" class="modal-warning modal-info" style="display: none;">
				<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<path d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"></path>
				</svg>
				<span>Для множественных точек откроется Яндекс.Карты, оттуда можно открыть в навигаторе</span>
			</div>
			<div class="modal-actions">
				<button id="openNaviBtn" class="btn btn-primary modal-btn">
					<svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
						<circle cx="12" cy="10" r="3"></circle>
					</svg>
					Яндекс.Навигатор
				</button>
				<button id="openMapsBtn" class="btn btn-outline modal-btn">
					<svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
						<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
						<circle cx="12" cy="10" r="3"></circle>
					</svg>
					Яндекс.Карты
				</button>
				<button id="cancelRouteBtn" class="btn btn-outline modal-btn">
					Отмена
				</button>
			</div>
		</div>
	</div>

	<div id="supplierModal" class="modal">
		<div class="modal-content modal-content-large">
			<h3 class="modal-title" id="supplierModalTitle">Добавить поставщика</h3>
			<form id="supplierForm" class="supplier-form">
				<div class="form-group">
					<label for="supplierName" class="form-label">Название *</label>
					<input type="text" id="supplierName" name="name" class="form-input" required placeholder="Например: Агропарк-М" />
				</div>
				<div class="form-group">
					<label for="supplierAddress" class="form-label">Адрес</label>
					<input type="text" id="supplierAddress" name="address" class="form-input" placeholder="Например: 4 пер. монтажников 5" />
				</div>
				<div class="form-group">
					<label for="supplierLat" class="form-label">Широта (lat) *</label>
					<input type="number" id="supplierLat" name="lat" class="form-input" step="any" required placeholder="53.874443" />
				</div>
				<div class="form-group">
					<label for="supplierLon" class="form-label">Долгота (lon) *</label>
					<input type="number" id="supplierLon" name="lon" class="form-input" step="any" required placeholder="27.413769" />
				</div>
				<div class="form-group">
					<label for="supplierWorkingHours" class="form-label">Время работы</label>
					<input type="text" id="supplierWorkingHours" name="working_hours" class="form-input" placeholder="Например: Пн-Пт: 9:00-18:00, Сб: 10:00-16:00" />
				</div>
				<div class="form-group">
					<label for="supplierAdditionalInfo" class="form-label">Дополнительная информация</label>
					<textarea id="supplierAdditionalInfo" name="additional_info" class="form-textarea" rows="4" placeholder="Любая дополнительная информация о поставщике..."></textarea>
					<small class="form-hint">Необязательное поле. Любая дополнительная информация</small>
				</div>
				<div class="form-group">
					<label for="supplierInfo" class="form-label">Дополнительные точки (JSON, опционально)</label>
					<textarea id="supplierInfo" name="info" class="form-textarea" rows="3" placeholder='{"Склад": "53.874443, 27.413769", "Офис": "53.883330, 27.455246"}'></textarea>
					<small class="form-hint">Необязательное поле. JSON объект с дополнительными точками для маршрутов</small>
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-primary modal-btn">Сохранить</button>
					<button type="button" id="cancelSupplierBtn" class="btn btn-outline modal-btn">Отмена</button>
					<button type="button" id="deleteSupplierBtn" class="btn btn-danger modal-btn" style="display: none;">Удалить</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Модальное окно для водителя -->
	<div id="driverModal" class="modal">
		<div class="modal-content modal-content-large">
			<h3 class="modal-title" id="driverModalTitle">Добавить водителя</h3>
			<form id="driverForm" class="supplier-form">
				<div class="form-group">
					<label for="driverName" class="form-label">ФИО *</label>
					<input type="text" id="driverName" name="name" class="form-input" required placeholder="Иванов Иван Иванович" />
				</div>
				<div class="form-group">
					<label for="driverPhone" class="form-label">Телефон</label>
					<input type="tel" id="driverPhone" name="phone" class="form-input" placeholder="+375 29 123-45-67" />
				</div>
				<div class="form-group">
					<label for="driverLicense" class="form-label">Номер водительского удостоверения</label>
					<input type="text" id="driverLicense" name="license_number" class="form-input" placeholder="AB123456" />
				</div>
				<div class="form-group">
					<label for="driverLicenseExpiry" class="form-label">Срок действия удостоверения</label>
					<input type="date" id="driverLicenseExpiry" name="license_expiry" class="form-input" />
				</div>
				<div class="form-group">
					<label for="driverNotes" class="form-label">Примечания</label>
					<textarea id="driverNotes" name="notes" class="form-textarea" rows="3" placeholder="Дополнительная информация..."></textarea>
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-primary modal-btn">Сохранить</button>
					<button type="button" id="cancelDriverBtn" class="btn btn-outline modal-btn">Отмена</button>
					<button type="button" id="deleteDriverBtn" class="btn btn-danger modal-btn" style="display: none;">Удалить</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Модальное окно для автомобиля -->
	<div id="vehicleModal" class="modal">
		<div class="modal-content modal-content-extra-large">
			<h3 class="modal-title" id="vehicleModalTitle">Добавить автомобиль</h3>
			<form id="vehicleForm" class="supplier-form two-columns">
				<div class="form-group">
					<label for="vehiclePlate" class="form-label">Гос. номер *</label>
					<input type="text" id="vehiclePlate" name="plate_number" class="form-input" required placeholder="1234 AB-7" />
				</div>
				<div class="form-group">
					<label for="vehicleDriver" class="form-label">Водитель</label>
					<select id="vehicleDriver" name="driver_id" class="form-input">
						<option value="">Не назначен</option>
					</select>
				</div>
				<div class="form-group">
					<label for="vehicleMileage" class="form-label">Пробег (км)</label>
					<input type="number" id="vehicleMileage" name="mileage" class="form-input" min="0" placeholder="0" />
				</div>
				<div class="form-group">
					<label for="vehicleFuelConsumption" class="form-label">Расход топлива (л/100км)</label>
					<input type="number" id="vehicleFuelConsumption" name="fuel_consumption" class="form-input" min="0" step="0.1" placeholder="10.5" />
				</div>
				<div class="form-group">
					<label for="vehicleOilChangeMileage" class="form-label">Пробег замены масла (км)</label>
					<input type="number" id="vehicleOilChangeMileage" name="oil_change_mileage" class="form-input" min="0" placeholder="50000" />
				</div>
				<div class="form-group">
					<label for="vehicleOilInterval" class="form-label">Регламент замены масла (км)</label>
					<input type="number" id="vehicleOilInterval" name="oil_change_interval" class="form-input" min="0" placeholder="10000" />
				</div>
				<div class="form-group full-width">
					<label for="vehicleOilInfo" class="form-label">Информация по замене масла</label>
					<textarea id="vehicleOilInfo" name="oil_change_info" class="form-textarea" rows="2" placeholder="Тип масла и т.д."></textarea>
				</div>
				<div class="form-group">
					<label for="vehicleInspectionStart" class="form-label">Техосмотр с</label>
					<input type="date" id="vehicleInspectionStart" name="inspection_start" class="form-input" />
				</div>
				<div class="form-group">
					<label for="vehicleInspection" class="form-label">Техосмотр до</label>
					<input type="date" id="vehicleInspection" name="inspection_expiry" class="form-input" />
				</div>
				<div class="form-group">
					<label for="vehicleInsuranceStart" class="form-label">Страховка с</label>
					<input type="date" id="vehicleInsuranceStart" name="insurance_start" class="form-input" />
				</div>
				<div class="form-group">
					<label for="vehicleInsurance" class="form-label">Страховка до</label>
					<input type="date" id="vehicleInsurance" name="insurance_expiry" class="form-input" />
				</div>
				<div class="form-group">
					<label for="vehiclePeriodStart" class="form-label">Период использования (с)</label>
					<input type="date" id="vehiclePeriodStart" name="driver_period_start" class="form-input" />
				</div>
				<div class="form-group">
					<label for="vehiclePeriodEnd" class="form-label">Период использования (по)</label>
					<input type="date" id="vehiclePeriodEnd" name="driver_period_end" class="form-input" />
				</div>
				<div class="form-group full-width">
					<label for="vehicleNotes" class="form-label">Примечания</label>
					<textarea id="vehicleNotes" name="notes" class="form-textarea" rows="3" placeholder="Дополнительная информация..."></textarea>
				</div>
				<div class="form-actions">
					<button type="submit" class="btn btn-primary modal-btn">Сохранить</button>
					<button type="button" id="cancelVehicleBtn" class="btn btn-outline modal-btn">Отмена</button>
					<button type="button" id="deleteVehicleBtn" class="btn btn-danger modal-btn" style="display: none;">Удалить</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Модальное окно для истории использования автомобиля -->
	<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
	<script src="js/config.js"></script>
	<script src="js/db.js"></script>
	<script src="js/db-vehicles.js"></script>
	<script src="js/app.js"></script>
	<script src="js/vehicles.js"></script>
</body>
</html>


